﻿@{
    ViewData["Title"] = "Rotide";
 }
<link rel="stylesheet" href="css/codemirror.css"/>
<link rel="stylesheet" href="css/monokai.css"/>
<style>
    .body-rotide {
        width: 100%;
        margin: 0;
        padding: 0;
    }

    .fileTree {
        border: black solid 1px;
    }

    .rotide-editor {
        width: 100%;
    }
</style>

<div class="container body-content body-rotide">
    <div class="row">
        <div>
            <div class="fileTree"></div>
        </div>
        <div class="col-lg-offset-3 col-lg-9">
            <textarea id="textInput" class="rotide-editor"></textarea>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-offset-4 col-lg-4">
            <input id="filePath" type="text">
        </div>
        <div class="col-lg-4">
            <button onclick="SaveFile()">Save file</button>
        </div>
    </div>
</div>
    
    

@section scripts{
    <script src="~/js/jQueryFileTree.js"></script>
    <script src="~/js/codemirror.js"></script>
    <script src="~/js/mode/javascript/javascript.js"></script>
    <script src="~/js/mode/clike/clike.js"></script>
    <script src="~/js/mode/css/css.js"></script>
    <script src="~/js/mode/htmlmixed/htmlmixed.js"></script>
    <script src="~/js/mode/lua/lua.js"></script>
    <script src="~/js/mode/markdown/markdown.js"></script>
    <script src="~/js/mode/php/php.js"></script>
    <script src="~/js/mode/python/python.js"></script>
    <script src="~/js/mode/sql/sql.js"></script>
    <script src="~/js/mode/xml/xml.js"></script>

    <script>
        var gRotide = {};
        var gLoadedFile = "";
        var gRotideElement = null;

        function OpenFile() {
            var filePath = $("#filePath").val();
            $.get("/Rotide/GetFileContents?filePath=" + filePath,
                function(data) {
                    $("#textInput").val(data);
                });
        }

        $(document).ready(function() {
            $(".fileTree").fileTree({ script: "/Rotide/GetFiles" },
                function(file) {
                    LoadFile(file);
                });

            gRotideElement = document.getElementById("textInput");
            gRotide = CodeMirror.fromTextArea(gRotideElement, {
                lineNumbers: true,
                mode: "javascript",
                theme: "monokai",
            });
            var rotideHeight = $(window).height() - 150; // TODO: find a better way to set the height of the editor window
            gRotide.setSize(-1, rotideHeight);
        });

        function LoadFile(file) {
            if (!HasValidExtension(file))
                return;

            $.get("/Rotide/GetFileContents",
                { filepath: file },
                function (data) {
                    gLoadedFile = file;
                    gRotide.setValue(data.content);
                    gRotide.setOption("mode", GetModeFromExtension(file));
                });
        }

        function SaveFile() {
            gRotide.save();

            var data = JSON.stringify({
                FilePath: gLoadedFile,
                FileContents: gRotide.getTextArea().value
            });

            $.ajax({
                type: "POST",
                url: "/Rotide/SaveFileContents",
                data: data,
                contentType: "application/json",
                success: function (data) {
                    console.log(data);
                }
            });
        }

        function GetModeFromExtension(fileName) {
            var ext = fileName.split('.')[1];
            var retValue = "";

            switch(ext) {
                case "txt":
                case "json":
                case "js":
                    retValue = "javascript";
                    break;
                case "cshtml":
                    retValue = "application/x-ejs";
                    break;
                case "html":
                case "htm":
                    retValue = "htmlmixed";
                    break;
                case "c":
                case "cpp":
                case "h":
                case "cs":
                    retValue = "text/x-c++src";
                    break;
                case "md":
                    retValue = "markdown";
                    break;
                case "css":
                    retValue = "css";
                    break;
                case "php":
                    retValue = "php";
                    break;
                case "py":
                    retValue = "python";
                    break;
                case "sql":
                    retValue = "sql";
                    break;
                case "xml":
                    retValue = "xml";
                    break;
                case "lua":
                    retValue = "lua";
                    break;
                default:
                    retValue = "javascript";
            }

            return retValue;
        }

        function HasValidExtension(fileName) {
            var ext = fileName.split('.').length === 2 ? fileName.split('.')[1] : "";
            if (ext === "")
                return false;

            switch(ext) {
                case "txt":
                case "js":
                case "html":
                case "htm":
                case "c":
                case "cpp":
                case "h":
                case "cs":
                case "cshtml":
                case "json":
                case "md":
                case "css":
                case "php":
                case "py":
                case "sql":
                case "xml":
                case "lua":
                    return true;
                    break;
                default:
                    return false;
            }
        }

    </script>
}
